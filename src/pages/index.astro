---
import { readFileSync } from 'fs';

const sitesFile = readFileSync('./sites.txt', 'utf-8');
const lines = sitesFile.split('\n');

const groups = [];
let currentGroup = { title: null, sites: [] };
groups.push(currentGroup);

for (const line of lines) {
  if (line.startsWith('## ')) {
    const title = line.substring(3).trim();
    if (title) {
      currentGroup = { title: title, sites: [] };
      groups.push(currentGroup);
    }
  } else if (line.trim()) {
    currentGroup.sites.push(line);
  }
}
---

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tile</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 1rem 0;
    }
    .group-title {
      font-size: 1.2rem;
      font-weight: bold;
      padding: 0.5rem 1rem;
      margin: 1.5rem 1rem 0.5rem 1rem;
      background-color: #e9e9e9;
      border-radius: 0.25rem;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .group-title .icon {
      width: 24px;
      height: 24px;
      transition: transform 0.3s ease;
    }
    .grid-container.collapsed .grid {
      display: none;
    }
    .grid-container.collapsed .icon {
      transform: rotate(-90deg);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1rem;
      max-width: 1200px;
      width: 100%;
      margin: auto;
    }
    .tile {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      padding: 1rem;
      text-decoration: none;
      color: black;
      transition: transform 0.2s;
    }
    .tile:hover {
      transform: scale(1.05);
    }
    .tile img {
      width: 32px;
      height: 32px;
      margin-bottom: 0.5rem;
    }
    h1 {
      text-align: center;
    }
  </style>
</head>
<body>
  {groups.map(group => {
    const gridContent = group.sites.length > 0 && (
      <div class="grid">
        {group.sites.map(site => {
          let siteUrl, name;
          const commaIndex = site.indexOf(',');
          if (commaIndex !== -1) {
            siteUrl = site.substring(0, commaIndex);
            name = site.substring(commaIndex + 1);
          } else {
            siteUrl = site;
            name = '';
          }
          const url = new URL(siteUrl);
          let finalName;
          if (name) {
            finalName = name;
          } else {
            let processedHostname = url.hostname;
            if (processedHostname.startsWith('www.')) {
              processedHostname = processedHostname.substring(4);
            }
            if (processedHostname.endsWith('.com')) {
              processedHostname = processedHostname.substring(0, processedHostname.length - 4);
            }
            finalName = processedHostname;
          }
          const favicon = `https://www.google.com/s2/favicons?sz=64&domain=${url.hostname}`;
          return (
            <a href={siteUrl} class="tile" target="_blank" rel="noopener noreferrer">
              <img src={favicon} alt={`Favicon for ${finalName}`} />
              <div>{finalName}</div>
            </a>
          )
        })}
      </div>
    );

    if (group.title) {
      return (
        <div class="grid-container collapsed">
          <h2 class="group-title">
            {group.title}
            <svg class="icon" viewBox="0 0 24 24">
              <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
            </svg>
          </h2>
          {gridContent}
        </div>
      );
    }

    return gridContent;
  })}
  <script>
    document.querySelectorAll('.group-title').forEach(title => {
      title.addEventListener('click', () => {
        const container = title.closest('.grid-container');
        if (container) {
          container.classList.toggle('collapsed');
        }
      });
    });
  </script>
</body>
</html>
